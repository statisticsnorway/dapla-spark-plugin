kind: pipeline
name: default

steps:
# Restore the cache if it exists
- name: restore-cache
  image: homerovalle/drone-gcs-cache
  settings:
    pull: true
    bucket: bip-drone-dependency-cache
    json_key:
      from_secret: gcs_credentials
    restore: true

- name: authenticate
  image: robertstettner/drone-mvn-auth
  pull: true
  settings:
    servers:
      from_secret: maven_servers

- name: build
  image: maven:3-jdk-8
  commands:
    - mvn compile -U -P ssb-bip -Djdk.tls.client.protocols="TLSv1.2" -Dmaven.repo.local=/drone/src/.m2/repository -DskipTests=true -Dmaven.javadoc.skip=true --batch-mode --global-settings settings.xml
  depends_on:
    - authenticate
    - restore-cache

- name: publish-maven
  image: maven:3-jdk-8
  commands:
    - mvn clean package deploy -P ssb-bip -Dmaven.repo.local=/drone/src/.m2/repository -DskipTests=true -Djdk.tls.client.protocols="TLSv1.2" --batch-mode --global-settings settings.xml
  when:
    ref:
      - refs/heads/feature/*
      - refs/heads/develop
      - refs/tags/*
  depends_on:
    - build

- name: publish-docker-zeppelin
  image: plugins/gcr
  settings:
    dockerfile: docker/zeppelin/Dockerfile
    repo: eu.gcr.io/prod-bip/ssb/lds-zeppelin
    registry: eu.gcr.io
    auto_tag: true
    json_key:
      from_secret: gcr_credentials
  when:
    ref:
      - refs/heads/develop
      - refs/tags/*
  depends_on:
    - publish-maven

- name: publish-docker-polynote
  image: plugins/gcr
  settings:
    dockerfile: docker/polynote/Dockerfile
    repo: eu.gcr.io/prod-bip/ssb/lds-polynote
    registry: eu.gcr.io
    auto_tag: true
    json_key:
      from_secret: gcr_credentials
  when:
    ref:
      - refs/heads/develop
      - refs/tags/*
  depends_on:
    - publish-maven

# Rebuild cache if it has changed with this build
- name: rebuild-cache
  image: homerovalle/drone-gcs-cache
  settings:
    pull: true
    bucket: bip-drone-dependency-cache
    json_key:
      from_secret: gcs_credentials
    rebuild: true
    mount:
      - .m2/repository
  depends_on:
    - publish-maven

# OPTIONAL: Flush the cache of old cache items (older than 14 days)
- name: flush-cache
  image: homerovalle/drone-gcs-cache
  settings:
    pull: true
    bucket: bip-drone-dependency-cache
    json_key:
      from_secret: gcs_credentials
    flush: true
    flush_age: 14
  depends_on:
    - publish-maven

---
kind: secret
name: maven_servers
get:
  path: drone-maven-servers
  name: ssb-bip-maven-servers

---
kind: secret
name: slack_webhook_url
get:
  path: drone-slack-webhook-url
  name: slack-webhook-url
---
kind: secret
name: sonar_host
get:
  path: drone-sonarqube-configuration
  name: url
---
kind: secret
name: sonar_token
get:
  path: drone-sonarqube-configuration
  name: token
---
kind: secret
name: gcr_credentials
get:
  path: drone-gcr-credentials
  name: gcr-credentials
---
kind: secret
name: gcs_credentials
get:
  path: drone-gcs-credentials
  name: gcs-credentials
